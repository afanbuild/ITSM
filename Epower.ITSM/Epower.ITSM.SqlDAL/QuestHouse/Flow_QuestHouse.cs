/********************************************************
* Generated By:   yanghw
* Date Generated: 2010年11月24日* ******************************************************/
using System;
using System.Data;
using System.Data.OracleClient;
using Epower.DevBase.BaseTools;
using Epower.ITSM.Base;
using Epower.DevBase.Organization.SqlDAL;
using Epower.DevBase.Organization.Base;

namespace Epower.ITSM.SqlDAL
{
    public class Flow_QuestHouse
    {
        /// <summary>
        /// 构造 函数
        /// </summary>
        public Flow_QuestHouse()
        { }

        /// <summary>
        /// 进出操作间查询单据
        /// </summary>
        /// <param name="lngUserID"></param>
        /// <param name="lngDeptID"></param>
        /// <param name="lngOrgID"></param>
        /// <param name="re"></param>
        /// <param name="pWhere"></param>
        /// <param name="pagesize"></param>
        /// <param name="pageindex"></param>
        /// <param name="rowcount"></param>
        /// <returns></returns>
        public static DataTable getQuestHouse(long lngUserID, long lngDeptID, long lngOrgID, RightEntity re, string pWhere, int pagesize, int pageindex, ref int rowcount)
        {
            string strList = "";       //存放部门列表
            string strWhere = "1=1 ";

            if (re == null || re.CanRead == false)
            {
                //查询出空结果
                strWhere += " AND flowid = -1 ";
            }
            else
            {
                #region 范围条件
                if (re != null)
                {
                    switch (re.RightRange)
                    {
                        case eO_RightRange.eFull:
                            strWhere += "";
                            break;
                        case eO_RightRange.ePersonal:
                            strWhere += " AND exists (SELECT messageid FROM es_message WHERE flowid = V_flow_questhouse.flowid AND receiverid = " + lngUserID.ToString() + ")";
                            break;
                        case eO_RightRange.eDeptDirect:
                            strWhere += " AND exists (SELECT messageid FROM es_message WHERE flowid = V_flow_questhouse.flowid AND recdeptid = " + lngDeptID.ToString() + ")";
                            break;
                        case eO_RightRange.eOrgDirect:
                            strWhere += " AND exists (SELECT messageid FROM es_message WHERE flowid = V_flow_questhouse.flowid AND recorgid = " + lngOrgID.ToString() + ")";
                            break;
                        case eO_RightRange.eDept:
                            strList = DeptDP.GetDeptFullID(lngDeptID);
                            if (strList.Trim().Length > 0)
                            {
                                //不是根部门并有找到


                                strWhere += " AND exists (SELECT messageid FROM es_message WHERE flowid = V_flow_questhouse.flowid AND recdeptid in (select deptid from ts_dept where fullid like '" + strList + "%'))";
                            }
                            break;
                        case eO_RightRange.eOrg:
                            strList = DeptDP.GetDeptFullID(lngOrgID);
                            if (strList.Trim().Length > 0)
                            {
                                //不是根部门并有找到


                                strWhere += " AND exists (SELECT messageid FROM es_message WHERE flowid = V_flow_questhouse.flowid AND recorgid in (select distinct deptid from ts_dept where deptkind = 1 and fullid like '" + strList + "%'))";
                            }
                            break;
                        default:
                            strWhere += "";
                            break;
                    }
                }
                #endregion
                strWhere += pWhere;
            }
            OracleConnection cn = ConfigTool.GetConnection("SQLConnString");
            try
            {
                DataTable dt = OracleDbHelper.ExecuteDataTable(cn, "V_flow_questhouse", "*", " ORDER BY HOUSEID DESC", pagesize, pageindex, strWhere, ref rowcount);
                return dt;
            }
            catch (Exception e)
            {
                throw e;
            }
            finally
            {
                ConfigTool.CloseConnection(cn);
            }
        }

        /// <summary>
        /// 进出操作间查询单据
        /// </summary>
        /// <param name="lngUserID"></param>
        /// <param name="lngDeptID"></param>
        /// <param name="lngOrgID"></param>
        /// <param name="re"></param>
        /// <param name="pWhere"></param>
        /// <param name="pagesize"></param>
        /// <param name="pageindex"></param>
        /// <param name="rowcount"></param>
        /// <returns></returns>
        public static DataTable getQuestHouse(long lngUserID, long lngDeptID, long lngOrgID, RightEntity re, string pWhere)
        {
            string strList = "";       //存放部门列表
            string strWhere = "1=1 ";

            if (re == null || re.CanRead == false)
            {
                //查询出空结果
                strWhere += " AND flowid = -1 ";
            }
            else
            {
                #region 范围条件
                if (re != null)
                {
                    switch (re.RightRange)
                    {
                        case eO_RightRange.eFull:
                            strWhere += "";
                            break;
                        case eO_RightRange.ePersonal:
                            strWhere += " AND exists (SELECT messageid FROM es_message WHERE flowid = V_flow_questhouse.flowid AND receiverid = " + lngUserID.ToString() + ")";
                            break;
                        case eO_RightRange.eDeptDirect:
                            strWhere += " AND exists (SELECT messageid FROM es_message WHERE flowid = V_flow_questhouse.flowid AND recdeptid = " + lngDeptID.ToString() + ")";
                            break;
                        case eO_RightRange.eOrgDirect:
                            strWhere += " AND exists (SELECT messageid FROM es_message WHERE flowid = V_flow_questhouse.flowid AND recorgid = " + lngOrgID.ToString() + ")";
                            break;
                        case eO_RightRange.eDept:
                            strList = DeptDP.GetDeptFullID(lngDeptID);
                            if (strList.Trim().Length > 0)
                            {
                                //不是根部门并有找到


                                strWhere += " AND exists (SELECT messageid FROM es_message WHERE flowid = V_flow_questhouse.flowid AND recdeptid in (select deptid from ts_dept where fullid like '" + strList + "%'))";
                            }
                            break;
                        case eO_RightRange.eOrg:
                            strList = DeptDP.GetDeptFullID(lngOrgID);
                            if (strList.Trim().Length > 0)
                            {
                                //不是根部门并有找到


                                strWhere += " AND exists (SELECT messageid FROM es_message WHERE flowid = V_flow_questhouse.flowid AND recorgid in (select distinct deptid from ts_dept where deptkind = 1 and fullid like '" + strList + "%'))";
                            }
                            break;
                        default:
                            strWhere += "";
                            break;
                    }
                }
                #endregion
                strWhere += pWhere;
            }
            string strSQL = "SELECT * FROM V_FLOW_QUESTHOUSE_EXCEL WHERE " + strWhere;//查询语句
            OracleConnection cn = ConfigTool.GetConnection("SQLConnString");
            try
            {
                DataTable dt = OracleDbHelper.ExecuteDataTable(cn, CommandType.Text, strSQL);//执行查询
                return dt;
            }
            catch (Exception e)
            {
                throw e;
            }
            finally
            {
                ConfigTool.CloseConnection(cn);
            }
        }

        //获取公司进入人员信息
        public static DataTable getUser(long HouseId)
        {
            string StrSQL = "select * from comeINJFpeople where HouseId=" + HouseId.ToString();
            OracleConnection cn = ConfigTool.GetConnection("SQLConnString");
            try
            {
                DataTable dt = OracleDbHelper.ExecuteDataTable(cn, CommandType.Text, StrSQL);
                return dt;
            }
            catch (Exception e)
            {
                throw e;
            }
            finally
            {
                ConfigTool.CloseConnection(cn);
            }
        }

        //获取公司进入人员信息
        public static DataTable getUserByOpObjId(long OpObjId)
        {
            string StrSQL = "select distinct username,logname,deptname,opobjid from comeINJFpeople where OpObjId=" + OpObjId.ToString();
            OracleConnection cn = ConfigTool.GetConnection("SQLConnString");
            try
            {
                DataTable dt = OracleDbHelper.ExecuteDataTable(cn, CommandType.Text, StrSQL);
                return dt;
            }
            catch (Exception e)
            {
                throw e;
            }
            finally
            {
                ConfigTool.CloseConnection(cn);
            }
        }
        /// <summary>
        /// 获取外公司进入人员信息

        /// </summary>
        /// <param name="HouseId"></param>
        /// <returns></returns>
        public static DataTable getCompurUser(long HouseId)
        {
            string StrSQL = "select * from ComeINJFcomperTbl where HouseId=" + HouseId.ToString();
            OracleConnection cn = ConfigTool.GetConnection("SQLConnString");
            try
            {
                DataTable dt = OracleDbHelper.ExecuteDataTable(cn, CommandType.Text, StrSQL);
                return dt;
            }
            catch (Exception e)
            {
                throw e;
            }
            finally
            {
                ConfigTool.CloseConnection(cn);
            }
        }

        /// <summary>
        /// 获取外公司进入人员信息

        /// </summary>
        /// <param name="HouseId"></param>
        /// <returns></returns>
        public static DataTable getCompurUserByObjId(long OpObjId)
        {
            string StrSQL = "select distinct peoplename,cardno,peoplephone,computename,opobjid from ComeINJFcomperTbl where opobjid=" + OpObjId.ToString();
            OracleConnection cn = ConfigTool.GetConnection("SQLConnString");
            try
            {
                DataTable dt = OracleDbHelper.ExecuteDataTable(cn, CommandType.Text, StrSQL);
                return dt;
            }
            catch (Exception e)
            {
                throw e;
            }
            finally
            {
                ConfigTool.CloseConnection(cn);
            }
        }

        /// <summary>
        /// 添加行外人员
        /// </summary>
        /// <param name="HouseId"></param>
        /// <param name="username"></param>
        /// <param name="cardNo"></param>
        /// <param name="phone"></param>
        /// <param name="compuerName"></param>
        public static void AddCompurUser(long HouseId, string username, string cardNo, string phone, string compuerName)
        {
            string StrSQL = " select nvl(max(comeId),0)+1 from ComeINJFcomperTbl";
            OracleConnection cn = ConfigTool.GetConnection("SQLConnString");
            try
            {
                DataTable dt = OracleDbHelper.ExecuteDataTable(cn, CommandType.Text, StrSQL);
                if (dt.Rows.Count > 0)
                {
                    string strSQL2 = "insert into ComeINJFcomperTbl(comeId,HouseId,peopleName,CardNO,PeoplePhone,computeName) " +
                            "values(" + dt.Rows[0][0].ToString() + "," + HouseId.ToString() + "," + StringTool.SqlQ(username) + "," + StringTool.SqlQ(cardNo) + " ," + StringTool.SqlQ(phone) + "," + StringTool.SqlQ(compuerName) + ") ";

                    OracleDbHelper.ExecuteNonQuery(cn, CommandType.Text, strSQL2);
                }
            }
            catch (Exception e)
            {
                throw e;
            }
            finally
            {
                ConfigTool.CloseConnection(cn);
            }
        }

        /// <summary>
        /// 添加行外人员
        /// </summary>
        /// <param name="HouseId"></param>
        /// <param name="username"></param>
        /// <param name="cardNo"></param>
        /// <param name="phone"></param>
        /// <param name="compuerName"></param>
        public static void AddCompurUser(long HouseId, string username, string cardNo, string phone, string compuerName, long opObjId)
        {
            string StrSQL = " select nvl(max(comeId),0)+1 from ComeINJFcomperTbl";
            OracleConnection cn = ConfigTool.GetConnection("SQLConnString");
            try
            {
                DataTable dt = OracleDbHelper.ExecuteDataTable(cn, CommandType.Text, StrSQL);
                if (dt.Rows.Count > 0)
                {
                    if (opObjId == 0)
                    {
                        string strSQL2 = "insert into ComeINJFcomperTbl(comeId,HouseId,peopleName,CardNO,PeoplePhone,computeName,OpObjId) " +
                                "values(" + dt.Rows[0][0].ToString() + "," + HouseId.ToString() + "," + StringTool.SqlQ(username) + "," +
                                StringTool.SqlQ(cardNo) + " ," + StringTool.SqlQ(phone) + "," + StringTool.SqlQ(compuerName) + ",NULL) ";

                        OracleDbHelper.ExecuteNonQuery(cn, CommandType.Text, strSQL2);
                    }
                    else
                    {
                        string strSQL2 = "insert into ComeINJFcomperTbl(comeId,HouseId,peopleName,CardNO,PeoplePhone,computeName,OpObjId) " +
                                "values(" + dt.Rows[0][0].ToString() + "," + HouseId.ToString() + "," + StringTool.SqlQ(username) + "," +
                                StringTool.SqlQ(cardNo) + " ," + StringTool.SqlQ(phone) + "," + StringTool.SqlQ(compuerName) + "," +
                                opObjId.ToString() + ") ";

                        OracleDbHelper.ExecuteNonQuery(cn, CommandType.Text, strSQL2);
                    }

                }
            }
            catch (Exception e)
            {
                throw e;
            }
            finally
            {
                ConfigTool.CloseConnection(cn);
            }
        }

        /// <summary>
        /// 删除公司方人员信息

        /// </summary>
        /// <param name="id"></param>
        public static void DLTcompurUser(long id)
        {
            string StrSQL = "delete ComeINJFcomperTbl where comeid=" + id.ToString();
            OracleConnection cn = ConfigTool.GetConnection("SQLConnString");
            try
            {
                OracleDbHelper.ExecuteDataTable(cn, CommandType.Text, StrSQL);
            }
            catch (Exception e)
            {
                throw e;
            }
            finally
            {
                ConfigTool.CloseConnection(cn);
            }
        }

        /// <summary>
        /// 删除公司方人员信息

        /// </summary>
        /// <param name="houseid"></param>
        /// <param name="opObjId"></param>
        public static void DLTcompurUserByHouseId(long houseid)
        {
            string strSQL = "delete ComeINJFcomperTbl where houseid=" + houseid.ToString();
            OracleConnection cn = ConfigTool.GetConnection("SQLConnString");
            try
            {
                OracleDbHelper.ExecuteDataTable(cn, CommandType.Text, strSQL);
            }
            catch (Exception e)
            {
                throw e;
            }
            finally
            {
                ConfigTool.CloseConnection(cn);
            }
        }

        /// <summary>
        /// 删除进入人员信息
        /// </summary>
        /// <param name="id"></param>
        public static void DLTINJFpeople(long id)
        {
            string StrSQL = "delete comeINJFpeople where INJFpeopleID=" + id.ToString();
            OracleConnection cn = ConfigTool.GetConnection("SQLConnString");
            try
            {
                OracleDbHelper.ExecuteDataTable(cn, CommandType.Text, StrSQL);
            }
            catch (Exception e)
            {
                throw e;
            }
            finally
            {
                ConfigTool.CloseConnection(cn);
            }
        }

        /// <summary>
        /// 删除进入人员信息
        /// </summary>
        /// <param name="id"></param>
        public static void DLTINJFpeopleByHouseId(long houseid)
        {
            string StrSQL = "delete comeINJFpeople where houseid=" + houseid.ToString();
            OracleConnection cn = ConfigTool.GetConnection("SQLConnString");
            try
            {
                OracleDbHelper.ExecuteDataTable(cn, CommandType.Text, StrSQL);
            }
            catch (Exception e)
            {
                throw e;
            }
            finally
            {
                ConfigTool.CloseConnection(cn);
            }
        }

        /// <summary>
        /// 删除ip 及用户信息

        /// </summary>
        /// <param name="id"></param>
        public static void DLTExecUserTbl(long id)
        {
            string StrSQL = "delete ExecUserTbl where execid=" + id.ToString();
            OracleConnection cn = ConfigTool.GetConnection("SQLConnString");
            try
            {
                OracleDbHelper.ExecuteDataTable(cn, CommandType.Text, StrSQL);
            }
            catch (Exception e)
            {
                throw e;
            }
            finally
            {
                ConfigTool.CloseConnection(cn);
            }
        }

        /// <summary>
        /// 删除ip 及用户信息

        /// </summary>
        /// <param name="id"></param>
        public static void DLTExecUserTblByHouseId(long id)
        {
            string StrSQL = "delete ExecUserTbl where HOUSEID=" + id.ToString();
            OracleConnection cn = ConfigTool.GetConnection("SQLConnString");
            try
            {
                OracleDbHelper.ExecuteDataTable(cn, CommandType.Text, StrSQL);
            }
            catch (Exception e)
            {
                throw e;
            }
            finally
            {
                ConfigTool.CloseConnection(cn);
            }
        }
        /// <summary>
        /// 获取ip和用户


        /// </summary>
        /// <param name="HouseId"></param>
        /// <returns></returns>
        public static DataTable getExecUserIP(long HouseId)
        {
            string StrSQL = "select IP from ExecUserTbl where  HouseId=" + HouseId.ToString() + " group by IP";
            OracleConnection cn = ConfigTool.GetConnection("SQLConnString");
            try
            {
                DataTable dt = OracleDbHelper.ExecuteDataTable(cn, CommandType.Text, StrSQL);
                return dt;
            }
            catch (Exception e)
            {
                throw e;
            }
            finally
            {
                ConfigTool.CloseConnection(cn);
            }
        }

        /// <summary>
        /// 获取ip和用户

        /// </summary>
        /// <param name="HouseId"></param>
        /// <returns></returns>
        public static DataTable getExecUserIPBill(long HouseId)
        {
            string StrSQL = "select * from ExecUserTbl where  HouseId=" + HouseId.ToString() + " order by ip";
            OracleConnection cn = ConfigTool.GetConnection("SQLConnString");
            try
            {
                DataTable dt = OracleDbHelper.ExecuteDataTable(cn, CommandType.Text, StrSQL);
                return dt;
            }
            catch (Exception e)
            {
                throw e;
            }
            finally
            {
                ConfigTool.CloseConnection(cn);
            }
        }

        /// <summary>
        /// 获取ip和用户

        /// </summary>
        /// <param name="HouseId"></param>
        /// <returns></returns>
        public static DataTable getExecUserIPBillByOpObjId(long opObjId)
        {
            string StrSQL = "select distinct IP,UserName,OpObjId from ExecUserTbl where  opobjid=" + opObjId.ToString() + " order by ip";
            OracleConnection cn = ConfigTool.GetConnection("SQLConnString");
            try
            {
                DataTable dt = OracleDbHelper.ExecuteDataTable(cn, CommandType.Text, StrSQL);
                return dt;
            }
            catch (Exception e)
            {
                throw e;
            }
            finally
            {
                ConfigTool.CloseConnection(cn);
            }
        }

        /// <summary>
        /// 获取ip下的用户名

        /// </summary>
        /// <param name="HouseId"></param>
        /// <param name="StrIP"></param>
        /// <returns></returns>
        public static string getExecUser(long HouseId, string StrIP)
        {
            string strUser = string.Empty;
            string StrSQL = "select userName from ExecUserTbl where  HouseId=" + HouseId.ToString() + " and IP=" + StringTool.SqlQ(StrIP);
            OracleConnection cn = ConfigTool.GetConnection("SQLConnString");
            try
            {
                DataTable dt = OracleDbHelper.ExecuteDataTable(cn, CommandType.Text, StrSQL);

                foreach (DataRow dr in dt.Rows)
                {
                    if (strUser == string.Empty)
                    {
                        strUser = dr["userName"].ToString();
                    }
                    else
                    {
                        strUser += " , " + dr["userName"].ToString();
                    }
                }
                return strUser;
            }
            catch (Exception e)
            {
                throw e;
            }
            finally
            {
                ConfigTool.CloseConnection(cn);
            }
        }


        /// <summary>
        /// 根据用户id找部门名称


        /// </summary>
        /// <param name="userId"></param>
        /// <returns></returns>
        public static string getExecDept(long userId)
        {
            string deptName = string.Empty;
            string StrSQL = "select  ts_dept.deptname,ts_user.loginname from ts_dept left join ts_userdept " +
                    " on ts_dept.deptid=ts_userdept.deptid " +
                     " left join ts_user on " +
                    " ts_userdept.UserId=ts_user.UserId " +
                     " where ts_user.UserId=" + userId;
            OracleConnection cn = ConfigTool.GetConnection("SQLConnString");
            try
            {
                DataTable dt = OracleDbHelper.ExecuteDataTable(cn, CommandType.Text, StrSQL);

                if (dt.Rows.Count > 0)
                {
                    deptName = dt.Rows[0]["deptname"].ToString() + "|" + dt.Rows[0]["loginname"].ToString();
                }
                return deptName;
            }
            catch (Exception e)
            {
                throw e;
            }
            finally
            {
                ConfigTool.CloseConnection(cn);
            }
        }


        /// <summary>
        /// 添加人员
        /// </summary>
        /// <param name="HouseId"></param>
        /// <param name="username"></param>
        /// <param name="loginName"></param>
        /// <param name="deptname"></param>

        public static void AddINJFpeoples(long HouseId, string username, string loginName, string deptname)
        {
            string StrSQL = " select nvl(max(inJfpeopleId),0)+1 from comeINJFpeople";
            OracleConnection cn = ConfigTool.GetConnection("SQLConnString");
            try
            {
                DataTable dt = OracleDbHelper.ExecuteDataTable(cn, CommandType.Text, StrSQL);
                if (dt.Rows.Count > 0)
                {
                    string strSQL2 = "declare cnt integer;begin select count(*) into cnt from comeINJFpeople where logname=" + StringTool.SqlQ(loginName) + " and HouseId=" + HouseId + ";if cnt = 0 then insert into comeINJFpeople(INJFpeopleID,HouseId,Username,logname,deptname) " +
                            "values(" + dt.Rows[0][0].ToString() + "," + HouseId.ToString() + "," + StringTool.SqlQ(username) + "," + StringTool.SqlQ(loginName) + " ," + StringTool.SqlQ(deptname) + ");end if;end; ";

                    OracleDbHelper.ExecuteNonQuery(cn, CommandType.Text, strSQL2);
                }
            }
            catch (Exception e)
            {
                throw e;
            }
            finally
            {
                ConfigTool.CloseConnection(cn);
            }
        }

        /// <summary>
        /// 添加人员
        /// </summary>
        /// <param name="HouseId"></param>
        /// <param name="username"></param>
        /// <param name="loginName"></param>
        /// <param name="deptname"></param>
        public static void AddINJFpeoples(long HouseId, string username, string loginName, string deptname, long opObjId)
        {
            string StrSQL = " select nvl(max(inJfpeopleId),0)+1 from comeINJFpeople";
            OracleConnection cn = ConfigTool.GetConnection("SQLConnString");
            try
            {
                DataTable dt = OracleDbHelper.ExecuteDataTable(cn, CommandType.Text, StrSQL);
                if (dt.Rows.Count > 0)
                {
                    if (opObjId == 0)
                    {
                        string strSQL2 = "declare cnt integer;begin select count(*) into cnt from comeINJFpeople where logname=" +
                                        StringTool.SqlQ(loginName) + " and HouseId=" + HouseId +
                                        ";if cnt = 0 then insert into comeINJFpeople(INJFpeopleID,HouseId,Username,logname,deptname,opObjId) " +
                                        "values(" + dt.Rows[0][0].ToString() + "," + HouseId.ToString() + "," + StringTool.SqlQ(username) + "," +
                                        StringTool.SqlQ(loginName) + " ," + StringTool.SqlQ(deptname) + ",'');end if;end; ";

                        OracleDbHelper.ExecuteNonQuery(cn, CommandType.Text, strSQL2);
                    }
                    else
                    {
                        string strSQL2 = "declare cnt integer;begin select count(*) into cnt from comeINJFpeople where logname=" +
                                        StringTool.SqlQ(loginName) + " and HouseId=" + HouseId +
                                        ";if cnt = 0 then insert into comeINJFpeople(INJFpeopleID,HouseId,Username,logname,deptname,opObjId) " +
                                        "values(" + dt.Rows[0][0].ToString() + "," + HouseId.ToString() + "," + StringTool.SqlQ(username) + "," +
                                        StringTool.SqlQ(loginName) + " ," + StringTool.SqlQ(deptname) + "," + opObjId.ToString() + ");end if;end; ";

                        OracleDbHelper.ExecuteNonQuery(cn, CommandType.Text, strSQL2);
                    }
                    //if (opObjId == 0)
                    //{
                    //    string strSQL2 = "select count(INJFpeopleID) from comeINJFpeople where logname =" +
                    //                    StringTool.SqlQ(loginName) + " and HouseId=" + HouseId;
                    //    DataTable dtTemp = OracleDbHelper.ExecuteDataTable(cn, CommandType.Text, strSQL2);
                    //    int cnt = 0;
                    //    if (dtTemp != null && dtTemp.Rows.Count > 0)
                    //    {
                    //        cnt = Convert.ToInt32(dt.Rows[0][0].ToString());
                    //    }
                    //    if (cnt == 0)
                    //    {
                    //        strSQL2 = "insert into comeINJFpeople(INJFpeopleID,HouseId,Username,logname,deptname,opObjId) " +
                    //                    "values(" + dt.Rows[0][0].ToString() + "," + HouseId.ToString() + "," + StringTool.SqlQ(username) + "," +
                    //                    StringTool.SqlQ(loginName) + " ," + StringTool.SqlQ(deptname) + ",null)";
                    //        OracleDbHelper.ExecuteNonQuery(cn, CommandType.Text, strSQL2);
                    //    }
                        
                    //}
                    //else
                    //{
                    //    string strSQL2 = "select count(INJFpeopleID) from comeINJFpeople where logname =" +
                    //                        StringTool.SqlQ(loginName) + " and HouseId=" + HouseId;
                    //    DataTable dtTemp = OracleDbHelper.ExecuteDataTable(cn, CommandType.Text, strSQL2);
                    //    int cnt = 0;
                    //    if (dtTemp != null && dtTemp.Rows.Count > 0)
                    //    {
                    //        cnt = Convert.ToInt32(dt.Rows[0][0].ToString());
                    //    }
                    //    if (cnt == 0)
                    //    {
                    //        strSQL2 = "insert into comeINJFpeople(INJFpeopleID,HouseId,Username,logname,deptname,opObjId) " +
                    //                    "values(" + dt.Rows[0][0].ToString() + "," + HouseId.ToString() + "," + StringTool.SqlQ(username) + "," +
                    //                    StringTool.SqlQ(loginName) + " ," + StringTool.SqlQ(deptname) + "," + opObjId.ToString() + ")";
                    //        OracleDbHelper.ExecuteNonQuery(cn, CommandType.Text, strSQL2);
                    //    }

                    //    //string strSQL2 = "declare cnt int;begin select  @cnt=count(INJFpeopleID) into cnt from comeINJFpeople where logname=" +
                    //    //                StringTool.SqlQ(loginName) + " and HouseId=" + HouseId +
                    //    //                ";if @cnt = 0 begin insert into comeINJFpeople(INJFpeopleID,HouseId,Username,logname,deptname,opObjId) " +
                    //    //                "values(" + dt.Rows[0][0].ToString() + "," + HouseId.ToString() + "," + StringTool.SqlQ(username) + "," +
                    //    //                StringTool.SqlQ(loginName) + " ," + StringTool.SqlQ(deptname) + "," + opObjId.ToString() + ");end end; ";

                    //    //OracleDbHelper.ExecuteNonQuery(cn, CommandType.Text, strSQL2);
                    //}
                }
            }
            catch (Exception e)
            {
                throw e;
            }
            finally
            {
                ConfigTool.CloseConnection(cn);
            }
        }

        /// <summary>
        /// 保存ip和用户地址
        /// </summary>
        /// <param name="HouseId"></param>
        /// <param name="username"></param>
        /// <param name="loginName"></param>
        /// <param name="deptname"></param>

        public static void AddExecUserTbl(long HouseId, string strIP, string loginName)
        {
            string StrSQL = " select nvl(max(execId),0)+1 from ExecUserTbl";
            OracleConnection cn = ConfigTool.GetConnection("SQLConnString");
            try
            {
                DataTable dt = OracleDbHelper.ExecuteDataTable(cn, CommandType.Text, StrSQL);
                if (dt.Rows.Count > 0)
                {
                    string strSQL2 = "insert into ExecUserTbl(execId,HouseId,IP,username) " +
                            "values(" + dt.Rows[0][0].ToString() + "," + HouseId.ToString() + "," + StringTool.SqlQ(strIP) + "," + StringTool.SqlQ(loginName) + ") ";

                    OracleDbHelper.ExecuteNonQuery(cn, CommandType.Text, strSQL2);
                }
            }
            catch (Exception e)
            {
                throw e;
            }
            finally
            {
                ConfigTool.CloseConnection(cn);
            }
        }

        /// <summary>
        /// 保存ip和用户地址
        /// </summary>
        /// <param name="HouseId"></param>
        /// <param name="strIP"></param>
        /// <param name="loginName"></param>
        /// <param name="opObjId"></param>
        public static void AddExecUserTbl(long HouseId, string strIP, string loginName, long opObjId)
        {
            string StrSQL = " select nvl(max(execId),0)+1 from ExecUserTbl";
            OracleConnection cn = ConfigTool.GetConnection("SQLConnString");
            try
            {
                DataTable dt = OracleDbHelper.ExecuteDataTable(cn, CommandType.Text, StrSQL);
                if (dt.Rows.Count > 0)
                {
                    if (opObjId == 0)
                    {
                        string strSQL2 = "insert into ExecUserTbl(execId,HouseId,IP,username,OpObjId) " +
                                "values(" + dt.Rows[0][0].ToString() + "," + HouseId.ToString() + "," +
                                StringTool.SqlQ(strIP) + "," + StringTool.SqlQ(loginName) + ",NULL) ";

                        OracleDbHelper.ExecuteNonQuery(cn, CommandType.Text, strSQL2);
                    }
                    else
                    {
                        string strSQL2 = "insert into ExecUserTbl(execId,HouseId,IP,username,OpObjId) " +
                                "values(" + dt.Rows[0][0].ToString() + "," + HouseId.ToString() + "," +
                                StringTool.SqlQ(strIP) + "," + StringTool.SqlQ(loginName) + "," + opObjId.ToString() + ") ";

                        OracleDbHelper.ExecuteNonQuery(cn, CommandType.Text, strSQL2);
                    }
                }
            }
            catch (Exception e)
            {
                throw e;
            }
            finally
            {
                ConfigTool.CloseConnection(cn);
            }
        }
    }
}
